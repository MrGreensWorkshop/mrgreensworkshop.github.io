<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>ラズパイピコでZephyrOS動かし、VS Codeでデバッグしてみよう</title><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" media="print" onload="this.media='all'"> <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"> </noscript><link rel="preconnect dns-prefetch" href="https://www.googletagmanager.com" crossorigin><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><meta name="google-site-verification" content="V8_OYoa-HOun0n_6OmlNBjYry1ZE9SZU1CwLv9GlD5k"><link rel="manifest" href="/assets/manifest.json"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" content="#f0f0f0"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Mr. Green's Workshop's App"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="msapplication-TileColor" content="#2d89ef"><meta name="msapplication-starturl" content="/"><meta name="application-name" content="Mr. Green's Workshop's App"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><link rel="canonical" href="https://www.mrgreensworkshop.com/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2" /><link rel="alternate" hreflang="ja-JP" href="https://www.mrgreensworkshop.com/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2" /><link rel="alternate" hreflang="ja" href="https://www.mrgreensworkshop.com/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2" /><link rel="alternate" hreflang="x-default" href="https://www.mrgreensworkshop.com/posts/2022-06-10-raspberry-pi-pico-zephyr-os-part-2" /><link rel="alternate" hreflang="en-US" href="https://www.mrgreensworkshop.com/posts/2022-06-10-raspberry-pi-pico-zephyr-os-part-2" /><link rel="alternate" hreflang="en" href="https://www.mrgreensworkshop.com/posts/2022-06-10-raspberry-pi-pico-zephyr-os-part-2" /><meta name="keywords" content="マイコン, ラズパイピコ, Zephyr RTOS, PicoProbe"><meta name="description" content="VS CodeでPicoProbeハードウェアデバッガーインターフェイスを使ってRaspberry Pi PicoでZephyrOSゼファーRTOSをデバッグする方法。"><meta name="robots" content="index, follow"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="ラズパイピコでZephyrOS動かし、VS Codeでデバッグしてみよう"><meta name="twitter:site" content="@MrGreenWrkshop"><meta name="twitter:description" content="VS CodeでPicoProbeハードウェアデバッガーインターフェイスを使ってRaspberry Pi PicoでZephyrOSゼファーRTOSをデバッグする方法。"><meta name="twitter:image" content="https://www.mrgreensworkshop.com/assets/img/posts/id_raspi_pico_zephyr_os_part2/mainja.jpg"><meta property="og:site_name" content="Mr. Green's Workshop"><meta property="og:type" content="article"><meta property="og:title" content="ラズパイピコでZephyrOS動かし、VS Codeでデバッグしてみよう"><meta property="og:description" content="VS CodeでPicoProbeハードウェアデバッガーインターフェイスを使ってRaspberry Pi PicoでZephyrOSゼファーRTOSをデバッグする方法。"><meta property="og:url" content="https://www.mrgreensworkshop.com/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2"><meta property="og:image" content="https://www.mrgreensworkshop.com/assets/img/posts/id_raspi_pico_zephyr_os_part2/mainja.jpg"><meta property="og:locale" content="ja_JP" ><meta property="og:locale:alternate" content="en_US"><meta property="article:author" content="Mr. Green's Workshop"><meta property="article:section" content="マイコン"><meta property="article:tag" content="ラズパイピコ"><meta property="article:tag" content="Zephyr RTOS"><meta property="article:tag" content="PicoProbe"> <script type="application/ld+json">{ "@context": "https://schema.org" ,"@graph": [ { "@type": "Person" ,"@id": "https://www.mrgreensworkshop.com/ja/#person" ,"name": "Mr. Green's Workshop" ,"url": "https://www.mrgreensworkshop.com/ja/tabs/about.html" ,"image": "https://www.mrgreensworkshop.com/assets/img/about/about.jpg" ,"description": "Mr. Green's Workshop は、プログラミング、ホームオートメーション(IoT)、電子工作、マイコン、DIY、3Dプリンター、ロボット、加工 / CNC、サーバー関連などのプロジェクトやコンテンツを作っています。" },{ "@type": "WebSite" ,"@id": "https://www.mrgreensworkshop.com/ja/#website" ,"url": "https://www.mrgreensworkshop.com/ja/" ,"name": "Mr. Green's Workshop" ,"description": "Mr. Green's Workshop は、プログラミング、ホームオートメーション(IoT)、電子工作、マイコン、DIY、3Dプリンター、ロボット、加工 / CNC、サーバー関連などのプロジェクトやコンテンツを作っています。" ,"publisher": {"@id": "https://www.mrgreensworkshop.com/ja/#person"} ,"inLanguage": "ja-JP" ,"sameAs": ["https://www.youtube.com/@MrGreensWorkshopJp","https://twitter.com/MrGreenWrkshop","https://www.instagram.com/mrgreenworkshop","https://github.com/MrGreensWorkshop/MrGreensWorkshop/blob/main/README-jp.md#readme","https://ko-fi.com/MrGreenWorkshop","https://www.patreon.com/MrGreenWorkshop"] ,"copyrightHolder" : {"@id": "https://www.mrgreensworkshop.com/ja/#person"} ,"copyrightYear" : "2022" },{ "@type": "WebPage" ,"@id": "https://www.mrgreensworkshop.com/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2#webpage" ,"url": "https://www.mrgreensworkshop.com/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2" ,"name": "ラズパイピコでZephyrOS動かし、VS Codeでデバッグしてみよう" ,"isPartOf": {"@id": "https://www.mrgreensworkshop.com/ja/#website"} ,"breadcrumb": {"@id": "https://www.mrgreensworkshop.com/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2#breadcrumb"} ,"primaryImageOfPage": "https://www.mrgreensworkshop.com/assets/img/posts/id_raspi_pico_zephyr_os_part2/mainja.jpg" ,"description": "VS CodeでPicoProbeハードウェアデバッガーインターフェイスを使ってRaspberry Pi PicoでZephyrOSゼファーRTOSをデバッグする方法。" ,"inLanguage": "ja-JP" ,"potentialAction": { "@type": "ReadAction" ,"target": "https://www.mrgreensworkshop.com/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2" } },{ "@type": "BreadcrumbList", "@id": "https://www.mrgreensworkshop.com/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2#breadcrumb", "itemListElement": [ { "@type": "ListItem" ,"position": 1 ,"name": "ホーム" ,"item": "https://www.mrgreensworkshop.com/ja/" }, { "@type": "ListItem" ,"position": 2 ,"name": "ブログ" ,"item": "https://www.mrgreensworkshop.com/ja/tabs/blog/" }, { "@type": "ListItem" ,"position": 3 ,"name": "ラズパイピコでZephyrOS動かし、VS Codeでデバッグしてみよう" } ] },{ "@type": "BlogPosting" ,"@id": "https://www.mrgreensworkshop.com/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2#content" ,"isPartOf": {"@id": "https://www.mrgreensworkshop.com/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2#webpage"} ,"mainEntityOfPage": {"@id": "https://www.mrgreensworkshop.com/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2#webpage"} ,"publisher": {"@id": "https://www.mrgreensworkshop.com/ja/#person"} ,"author": {"@id": "https://www.mrgreensworkshop.com/ja/#person"} ,"inLanguage": "ja-JP" ,"headline": "ラズパイピコでZephyrOS動かし、VS Codeでデバッグしてみよう" ,"image": "https://www.mrgreensworkshop.com/assets/img/posts/id_raspi_pico_zephyr_os_part2/mainja.jpg" ,"thumbnailUrl": "https://www.mrgreensworkshop.com/assets/img/posts/id_raspi_pico_zephyr_os_part2/mainja.jpg" ,"articleSection": ["マイコン", "ラズパイピコ", "Zephyr RTOS", "PicoProbe"] ,"description": "VS CodeでPicoProbeハードウェアデバッガーインターフェイスを使ってRaspberry Pi PicoでZephyrOSゼファーRTOSをデバッグする方法。" ,"copyrightHolder" : {"@id": "https://www.mrgreensworkshop.com/ja/#person"} ,"copyrightYear" : "2022" ,"wordCount": 935 ,"articleBody": "この投稿では、Zephyr RTOS用のアプリを作る方法と、ラズパイピコでデバッグする方法について説明します。こちらのビデオで、開発環境のセットアップ方法について説明していますので、必要に応じてそちらを先に見てください。 サンプルアプリの選択 やりたいことに近い、ベースとなるサンプルアプリを選びましょう。今回は、外部割り込みのサンプルが必要です。Zephyrのサンプルアプリフォルダーを確認してみましょう。 $ cd ~/zephyrproject/zephyr/samples $ ls application_development drivers posix arch hello_world sensor basic index.rst shields bluetooth kernel subsys boards modules synchronization classic.rst net tfm_integration compression philosophers userspace $ cd basic $ ls basic.rst blinky_pwm fade_led rgb_led threads blinky button minimal servo_motor $ cd button $ ls CMakeLists.txt README.rst prj.conf sample.yaml src ボタンサンプルのソースコードを確認してみましょう。ここに外部割り込み設定があります。 cat src/main.c ... void main(void) { ... ret = gpio_pin_interrupt_configure_dt(&amp;button, GPIO_INT_EDGE_TO_ACTIVE); ... gpio_init_callback(&amp;button_cb_data, button_pressed, BIT(button.pin)); gpio_add_callback(button.port, &amp;button_cb_data); ... } このサンプルアプリをベースにします。 スタンドアロンZephyrアプリの作成方法 アプリケーションは３種類あります。 zephyrproject/zephyr/ フォルダーにあるアプリは、Zephyrリポジトリアプリケーションと呼ばれています。 zephyrproject フォルダーにあるアプリは、Zephyrワークスペースアプリケーションと呼ばれています。 zephyrproject フォルダーの外にあるアプリケーションは、Zephyr自立型アプリケーションと呼ばれています。 &lt;home&gt;/ ├─── zephyrproject/ │ ├─── .west/ │ │ └─── config │ ├─── zephyr/ │ │ ├── arch/ │ │ ├── boards/ │ │ ├── cmake/ │ │ ├── samples/ │ │ │ ├── hello_world/ -&gt; Zephyrリポジトリアプリケーション │ │ │ └── ... │ │ ├── tests/ │ │ └── ... │ ├── bootloader/ │ ├── modules/ │ ├── ... │ └── applications/ │ └── app/ -&gt; Zephyrワークスペースアプリケーション │ └─── app/ -&gt; Zephyr自立型アプリケーション ├── CMakeLists.txt ├── prj.conf └── src/ └── main.c Zephyr Project参考資料: アプリケーション開発 今回は自立型アプリケーションを作って行きます。ボタンサンプルフォルダーをコピーすることから始めましょう。プロジェクトフォルダー名やプロジェクトフォルダーパスにスペースがあるとコンパイルが通りませんので、スペースを使わないでください。 cd ~/ cp -R ~/zephyrproject/zephyr/samples/basic/button ~/Desktop/gpio_int_test ボタンサンプルは変更なしでnucleoボード用にコンパイルできるので、最初にnucleoボード用にコンパイルしてみます。 $ cd ~/Desktop/gpio_int_test $ west build -b nucleo_f411re usage: west [-h] [-z ZEPHYR_BASE] [-v] [-V] &lt;command&gt; ... west: error: argument &lt;command&gt;: invalid choice: 'build' (choose from 'init', 'update', 'list', 'manifest', 'diff', 'status', 'forall', 'help', 'config', 'topdir', 'selfupdate') $ 資料によると、いくつかの環境変数を設定する必要があります。これは、また後で直します。 Zephyr Project参考資料: 環境変数 一時的に、Zephyr環境スクリプトを実行します。これで、環境変数はターミナルが閉じるまで使えます。 $ source ~/zephyrproject/zephyr/zephyr-env.sh $ west build -b nucleo_f411re -- west build: generating a build system Loading Zephyr default modules (Zephyr base). -- Application: /Users/user/Desktop/gpio_int_test -- Found Python3: /usr/local/opt/python@3.9/bin/python3.9 (found suitable exact version \"3.9.13\") found components: Interpreter -- Cache files will be written to: /Users/user/Library/Caches/zephyr -- Zephyr version: 3.0.99 (/Users/user/zephyrproject/zephyr) -- Found west (found suitable version \"0.13.1\", minimum required is \"0.7.1\") -- Board: nucleo_f411re ... [156/156] Linking C executable zephyr/zephyr.elf Memory region Used Size Region Size %age Used FLASH: 15108 B 512 KB 2.88% SRAM: 4416 B 128 KB 3.37% IDT_LIST: 0 GB 2 KB 0.00% 問題なくコンパイルが通りました。 VS Codeプロジェクトのセットアップ VS CodeでスタンドアロンZephyrアプリをセットアップしましょう。コピーしたプロジェクトフォルダーをVS Codeで開きます。ビルドフォルダーを削除します。 Zephyr環境変数をプロジェクトに追加しましょう。これにより、環境変数がVS Codeターミナルに追加されます。 新しいフォルダーを作り、名前を .vscode にします。 そして、中に新しいファイルを作り、名前を settings.json にします。 ここに環境変数設定を入れます。 { \"terminal.integrated.env.osx\": { \"PATH\": \"$HOME/zephyrproject/zephyr/scripts\", \"ZEPHYR_BASE\": \"${env:HOME}/zephyrproject/zephyr\", }, \"terminal.integrated.env.linux\": { \"PATH\": \"$HOME/zephyrproject/zephyr/scripts:${env:PATH}\", \"ZEPHYR_BASE\": \"${env:HOME}/zephyrproject/zephyr\", }, \"terminal.integrated.env.windows\": { \"PATH\": \"${env:USERPROFILE}\\\\zephyrproject\\\\zephyr\\\\scripts;${env:PATH}\", \"ZEPHYR_BASE\": \"${env:USERPROFILE}\\\\zephyrproject\\\\zephyr\", }, } ワークスペース設定の詳細については、こちらを参照してください。 次に、プロジェクトを再度開き、コンパイルしてみます。 $ west build -b nucleo_f411re -- west build: generating a build system Loading Zephyr default modules (Zephyr base). -- Application: /Users/user/Desktop/gpio_int_test -- Found Python3: /usr/local/opt/python@3.9/bin/python3.9 (found suitable exact version \"3.9.13\") found components: Interpreter -- Cache files will be written to: /Users/user/Library/Caches/zephyr -- Zephyr version: 3.0.99 (/Users/user/zephyrproject/zephyr) -- Found west (found suitable version \"0.13.1\", minimum required is \"0.7.1\") -- Board: nucleo_f411re ... [156/156] Linking C executable zephyr/zephyr.elf Memory region Used Size Region Size %age Used FLASH: 15108 B 512 KB 2.88% SRAM: 4416 B 128 KB 3.37% IDT_LIST: 0 GB 2 KB 0.00% 問題なくコンパイルが通りました。 ボード名を設定しましょう。CMakeListsファイルを開き、cmake_minimum_requiredの後にset(BOARD rpi_pico)を足してください。 ... cmake_minimum_required(VERSION 3.20.0) set(BOARD rpi_pico) ... ボードオプションなしでコンパイルしてみましょう。 $ west build -p ... /Users/user/Desktop/gpio_int_test/src/main.c:22:2: error: #error \"Unsupported board: sw0 devicetree alias is not defined\" 22 | #error \"Unsupported board: sw0 devicetree alias is not defined\" | ^~~~~ [117/160] Building C object zephyr/drivers/gpio/CMakeFiles/drivers__gpio.dir/gpio_rpi_pico.c.obj ninja: build stopped: subcommand failed. FATAL ERROR: command exited with status 1: /usr/local/bin/cmake --build /Users/user/Desktop/gpio_int_test/build ラズパイピコボードにスイッチがないため、コンパイルエラーが発生しました。 Switch0の追加 switch0を追加しましょう。このために、アプリオーバーレイファイルを使います。nucleoボードのデバイスオーバーレイファイルでswitch0の定義を確認してみましょう。 $ cat /Users/wizard/zephyrproject/zephyr/boards/arm/nucleo_f411re/nucleo_f411re.dts ... / { gpio_keys { compatible = \"gpio-keys\"; user_button: button { label = \"User\"; gpios = &lt;&amp;gpioc 13 GPIO_ACTIVE_LOW&gt;; }; }; aliases { led0 = &amp;green_led_2; sw0 = &amp;user_button; }; }; ... 新しいファイルを作り、名前を app.overlay にします。必要なものをその中に入れましょう。 / { gpio_keys { compatible = \"gpio-keys\"; user_button: button { label = \"User\"; gpios = &lt;&amp;gpio0 28 GPIO_ACTIVE_LOW&gt;; }; }; aliases { sw0 = &amp;user_button; }; }; Zephyr Project参考資料: Device tree HOW TOs 私の回路で、スイッチはGPIO28に接続されています。回路図は後でお見せします。 コンパイルしてみましょう。 $ west build -p WARNING: This looks like a fresh build and BOARD is unknown; so it probably won't work. To fix, use --board=&lt;your-board&gt;. Note: to silence the above message, run 'west config build.board_warn false' -- west build: generating a build system ... [160/160] Linking C executable zephyr/zephyr.elf Memory region Used Size Region Size %age Used BOOT_FLASH: 256 B 256 B 100.00% FLASH: 11940 B 2096896 B 0.57% SRAM: 3760 B 264 KB 1.39% IDT_LIST: 0 GB 2 KB 0.00% Converting to uf2, output size: 24576, start address: 0x10000000 Wrote 24576 bytes to zephyr.uf2 $ gpio_int_test % やったー！ バイナリファイルは build/zephyr フォルダーにあります。 westコマンドの詳細について、以下の資料を参考にしてください。 Zephyr Project参考資料: ビルド、フラッシュ、およびデバッグ デバッグする方法 ラスパイピコ上のZephyrOS + アプリを使用したオンチップデバッグ 必要なもの ハードウェアデバッガインターフェイス（SWD） picoprobe ファームウェアが書き込まれたラスパイピコ オンチップデバッグ用のソフトウェア picoprobe用のOpenOCDビルド アームツールチェーン arm-none-eabi-gdb VS Code の Cortex-Debug 拡張機能 オンチップデバッグするには、いくつかのハードウェアとソフトウェアが必要です。 一つずつ準備していきましょう。 ハードウェアデバッガーインターフェイス まずはハードウェアです。ハードウェアデバッガーインターフェイスとしてpicoprobeを使います。 picoprobe用にコンパイルされたバイナリをダウンロードし、ラズパイピコに書き込みましょう。このリンクを開き、 Debugging using another Raspberry Pi Pico の下にある　Download the UF2 file　からダウンロードしてください。 ラズパイピコのbootselボタンを押しながらパソコンに差し、ブートローダーモードにします。 $ cp ~/Downloads/picoprobe.uf2 /Volumes/RPI-RP2/ OpenOCDのビルド 現在、OpenOCDはpicoprobeを公式にサポートしていないので、picoprobe用のバージョンをビルドする必要があります。 macOS用 cd ~/ brew install libtool automake libusb wget pkg-config gcc texinfo git clone https://github.com/raspberrypi/openocd.git --branch picoprobe --depth=1 cd openocd export PATH=\"/usr/local/opt/texinfo/bin:$PATH\" ./bootstrap ./configure --enable-picoprobe --disable-werror make -j4 Linux用 cd ~/pico sudo apt install automake autoconf build-essential texinfo libtool libftdi-dev libusb-1.0-0-dev git clone https://github.com/raspberrypi/openocd.git --branch picoprobe --depth=1 --no-single-branch cd openocd ./bootstrap ./configure --enable-picoprobe make -j4 sudo make i これはOpenOCDのラズパイピコ固有のバージョンなので、「makeinstall」を実行する必要はありません。後でOpenOCDのパスを VS Code プロジェクトに設定します。 OpenOCDを確認してみましょう。 $ ~/openocd/src/openocd --version Open On-Chip Debugger 0.11.0-g4f2ae61 (2022-06-08-15:59) Licensed under GNU GPL v2 For bug reports, read http://openocd.org/doc/doxygen/bugs.html ARMツールのインストール macOS用 cd ~/ brew tap eblot/armeabi brew install arm-none-eabi-gdb arm-none-eabi-gdbを確認してみましょう。 $ arm-none-eabi-gdb --version GNU gdb (GDB) 10.1 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. VS Codeの設定 まず、Cortex-Debugをインストールします。 settings.jsonファイルを開き、OpenOCDのバイナリパスを追加します。 { \"cortex-debug.openocdPath\": \"${env:HOME}/openocd/src/openocd\", ... .vscodeフォルダーに新しいファイルを作り、名前を launch.json にします。そして、設定を追加します。 { \"version\": \"0.2.0\", \"configurations\": [{ \"name\": \"Pico Zephyr Debug\", \"device\": \"RP2040\", \"gdbPath\": \"arm-none-eabi-gdb\", \"cwd\": \"${workspaceRoot}\", \"executable\": \"build/zephyr/zephyr.elf\", \"request\": \"launch\", \"type\": \"cortex-debug\", \"servertype\": \"openocd\", \"configFiles\": [ \"/interface/picoprobe.cfg\", \"/target/rp2040.cfg\" ], \"searchDir\": [\"${env:HOME}/openocd/tcl\"], \"svdFile\": \"${env:HOME}/zephyrproject/modules/hal/rpi_pico/src/rp2040/hardware_regs/rp2040.svd\", \"runToEntryPoint\": \"main\", \"postRestartCommands\": [ \"break main\", \"continue\" ] }] } 最終回路図 これはこれから使う回路の回路図です。左はハードウェアデバッガインターフェイス、右はボタンのあるターゲットボードです。 デバッグ開始 main.cを開き、行番号の左側をクリックします。それに応じてブレークポイントが追加されます。 デバッグする前にコンパイルすることを忘れないでください。次に、左側の「実行とデバッグ」アイコンをクリックします。「デバッグの開始」をクリックします。 やったー！ Zephyrコンソールの出力をシリアルターミナルで確認してみましょう。ボタンを押して、コンソールの出力を確認してみましょう。 素晴らしい！ スポンサーシップ 何もないところからプロジェクトを立ち上げるのは、とても時間がかかるものです。私がこの様なプロジェクトに取り組み続け、皆さんに新しいコンテンツを提供できるよう、支援をご検討いただければ幸いです。 Patreonで支援する（月々） Ko-fiで支援する (一回) GitHubでスポンサーになる (一回／月々) 最後に ラズパイピコ Zephyr RTOS VS Codeプロジェクトに、こちらのリンクからアクセスできます。 次のエピソードでは、ZephyrOSを使って実際のアプリケーションについて説明します。 つづく…" } ] }</script><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link href="/assets/css/main.css" rel="stylesheet"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v0.4.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/magnific-popup.css"><link href="/assets/css/nav-media.css" rel="stylesheet"></head><body > <script src="/assets/js/color-scheme-attr-init.js" data-mode="false"></script><nav class="navbar navbar-default top-nav"><div class="navbar-header"> <button type="button" aria-label="サイドメニュー" class="navbar-toggle collapsed pull-left top-nav-menu-toggle" data-toggle="collapse" data-target="#id_top-nav-menu-toggle" aria-expanded="false"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand top-nav-brand" href="/ja/" translate="no">Mr. Green's Workshop</a></div><div class="color_scheme_switch_top_holder" data-toggle="tooltip" data-placement="bottom" title="配色"> <label class="color-scheme-switch hover-effect"> <input type="checkbox" class="checkbox_color_switch" /> <span></span> </label></div></nav><nav id="side-nav-container"><div class="side-nav"><div class="side-nav-brand"> <img src="/assets/img/about/about.jpg" alt=""><div class="brand-holder"></div><p>&nbsp;</p><br><div class="lang-switch"><p>[&nbsp;</p><ul translate="no"><li lang="en-US"><a href="/posts/2022-06-10-raspberry-pi-pico-zephyr-os-part-2" class=" hover-effect">En&nbsp;</a></li><li lang="ja-JP"><a href="/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2" class=" active-page hover-effect">Jp&nbsp;</a></li></ul><p>]</p></div></div><br> <a href="javascript:void(0);" class="side-nav-close" role="button" rel="nofollow"> <i class="fa fa-angle-double-left fa-2x" aria-hidden="true"></i> </a><hr> <br><div class="side-nav-buttons"><ul class="nav nav-pills nav-stacked"><li ><a href="/ja/" class=" hover-effect"><i class="fa-fw fa fa-home" aria-hidden="true"></i>ホーム</a></li><li ><a href="/ja/tabs/blog/" class="active-page hover-effect"><i class="fa-fw fa fa-pencil-square-o" aria-hidden="true"></i>ブログ</a></li><li ><a href="/ja/tabs/archive.html" class=" hover-effect"><i class="fa-fw fa fa-archive" aria-hidden="true"></i>アーカイブ</a></li><li ><a href="/ja/tabs/about.html" class=" hover-effect"><i class="fa-fw fa fa-user-o" aria-hidden="true"></i>私について</a></li></ul></div><br> <br><div class="contact-container"><hr><h3>コンタクト</h3><ul><li><a href="https://www.youtube.com/@MrGreensWorkshopJp" aria-label="youtube" class="hover-effect-big" target="_blank" rel="noopener noreferrer"><i class="fa fa-youtube-play" aria-hidden="true"></i></a></li><li><a href="https://twitter.com/MrGreenWrkshop" aria-label="twitter" class="hover-effect-big" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a href="https://www.instagram.com/mrgreenworkshop" aria-label="instagram" class="hover-effect-big" target="_blank" rel="noopener noreferrer"><i class="fa fa-instagram" aria-hidden="true"></i></a></li><li><a href="https://github.com/MrGreensWorkshop/MrGreensWorkshop/blob/main/README-jp.md#readme" aria-label="github" class="hover-effect-big" target="_blank" rel="noopener noreferrer"><i class="fa fa-github" aria-hidden="true"></i></a></li><li><a href="https://ko-fi.com/MrGreenWorkshop" aria-label="ko-fi" class="hover-effect-big" target="_blank" rel="noopener noreferrer"><img src="/assets/img/default/kofi.svg" alt="ko-fi"/></a></li><li><a href="https://www.patreon.com/MrGreenWorkshop" aria-label="patreon" class="hover-effect-big" target="_blank" rel="noopener noreferrer"><img src="/assets/img/default/patreon.svg" alt="patreon"/></a></li></ul></div><hr id="toc-view-top"><div class="side-nav-footer" translate="no"><p>&copy; 2022 Mr. Green's Workshop.</p></div></div><div class="side-nav-bottom-buttons-container"><hr><ul><li><div class="color_scheme_switch_side_holder" data-toggle="tooltip" data-placement="top" title="配色"> <label class="color-scheme-switch hover-effect"> <input type="checkbox" class="checkbox_color_switch" /> <span></span> </label></div></li><li><div class="cookie-icon hover-effect" onclick="CookieConsent.showSettings();" data-toggle="tooltip" data-placement="top" title="クッキー設定"><div class="cookie-wrapper"> <i class="fa fa-circle bitten-cookie" aria-hidden="true"></i> <i class="fa fa-circle small-ellipse-icon" aria-hidden="true"></i> <i class="fa fa-spinner inner-icon" aria-hidden="true"></i> <i class="fa fa-circle-thin outer-icon" aria-hidden="true"></i></div></div></li></ul></div></nav><div id="toc-container" class="movable"><div class="panel panel-default"><div class="panel-heading" data-toggle="tooltip" data-placement="top" title="ドラッグして移動"> 見出し <span class="pull-right"> <a href="javascript:void(0);" aria-label="閉じる" role="button" rel="nofollow" class="close-button" onclick="document.getElementById('toc-container').style.display = 'none';"> <i class="fa fa-times" data-toggle="tooltip" data-placement="bottom" title="閉じる"></i> </a> </span></div><div class="panel-body"><nav id="table-of-contents"></nav></div></div></div><div id="main-wrapper"><div class="main-container"><div class="multipurpose-container post-container"><div class="post-title"><h1>ラズパイピコでZephyrOS動かし、VS Codeでデバッグしてみよう</h1></div><div class="meta"> <small> &nbsp;<i class="fa fa-calendar"></i>&nbsp;&nbsp;2022年06月16日 </small> <small> &nbsp;&nbsp;&nbsp;<span><i class="fa fa-clock-o"></i>&nbsp;20分で読めます</span> </small></div><hr/><div class="markdown-style"><p><img class="lozad imgViewer mfp-zoom" data-mfp-src="/assets/img/posts/id_raspi_pico_zephyr_os_part2/mainja.jpg" data-src="/assets/img/posts/id_raspi_pico_zephyr_os_part2/mainja.jpg" alt="Zephyr RTOS＋ラズパイピコでデバッグ" data-align="center" /></p><p>この投稿では、Zephyr RTOS用のアプリを作る方法と、ラズパイピコでデバッグする方法について説明します。<a href="https://youtu.be/ouUglJQ57Ek">こちらのビデオ</a>で、開発環境のセットアップ方法について説明していますので、必要に応じてそちらを先に見てください。</p><div class="video-wrapper video-centered"><div class="video-container"> <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/cmK_jPGGA5o" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><h3 id="サンプルアプリの選択">サンプルアプリの選択</h3><p>やりたいことに近い、ベースとなるサンプルアプリを選びましょう。今回は、外部割り込みのサンプルが必要です。Zephyrのサンプルアプリフォルダーを確認してみましょう。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd ~/zephyrproject/zephyr/samples
$ ls
application_development	drivers			posix
arch			hello_world		sensor
basic			index.rst		shields
bluetooth		kernel			subsys
boards			modules			synchronization
classic.rst		net			tfm_integration
compression		philosophers		userspace
$ cd basic
$ ls
basic.rst	blinky_pwm	fade_led	rgb_led		threads
blinky		button		minimal		servo_motor
$ cd button
$ ls
CMakeLists.txt	README.rst	prj.conf	sample.yaml	src
</code></pre></div></div><p>ボタンサンプルのソースコードを確認してみましょう。ここに外部割り込み設定があります。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat src/main.c
...
void main(void)
{
...
    ret = gpio_pin_interrupt_configure_dt(&amp;button, GPIO_INT_EDGE_TO_ACTIVE);
...
    gpio_init_callback(&amp;button_cb_data, button_pressed, BIT(button.pin));
    gpio_add_callback(button.port, &amp;button_cb_data);
...
}
</code></pre></div></div><p>このサンプルアプリをベースにします。</p><h3 id="スタンドアロンzephyrアプリの作成方法">スタンドアロンZephyrアプリの作成方法</h3><p>アプリケーションは３種類あります。</p><ol><li>zephyrproject/zephyr/ フォルダーにあるアプリは、Zephyrリポジトリアプリケーションと呼ばれています。</li><li>zephyrproject フォルダーにあるアプリは、Zephyrワークスペースアプリケーションと呼ばれています。</li><li>zephyrproject フォルダーの外にあるアプリケーションは、Zephyr自立型アプリケーションと呼ばれています。</li></ol><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;home&gt;/
├─── zephyrproject/
│     ├─── .west/
│     │    └─── config
│     ├─── zephyr/
│     │    ├── arch/
│     │    ├── boards/
│     │    ├── cmake/
│     │    ├── samples/
│     │    │   ├── hello_world/  -&gt; Zephyrリポジトリアプリケーション
│     │    │   └── ...
│     │    ├── tests/
│     │    └── ...
│     ├── bootloader/
│     ├── modules/
│     ├── ...
│     └── applications/
│         └── app/               -&gt; Zephyrワークスペースアプリケーション
│
└─── app/                        -&gt; Zephyr自立型アプリケーション
     ├── CMakeLists.txt
     ├── prj.conf
     └── src/
         └── main.c
</code></pre></div></div><p>Zephyr Project参考資料: <a href="https://docs.zephyrproject.org/latest/develop/application/index.html">アプリケーション開発</a></p><p>今回は自立型アプリケーションを作って行きます。ボタンサンプルフォルダーをコピーすることから始めましょう。プロジェクトフォルダー名やプロジェクトフォルダーパスにスペースがあるとコンパイルが通りませんので、スペースを使わないでください。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~/
cp -R ~/zephyrproject/zephyr/samples/basic/button ~/Desktop/gpio_int_test
</code></pre></div></div><p>ボタンサンプルは変更なしでnucleoボード用にコンパイルできるので、最初にnucleoボード用にコンパイルしてみます。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd ~/Desktop/gpio_int_test
$ west build -b nucleo_f411re
usage: west [-h] [-z ZEPHYR_BASE] [-v] [-V] &lt;command&gt; ...
west: error: argument &lt;command&gt;: invalid choice: 'build' (choose from 'init', 'update', 'list', 'manifest', 'diff', 'status', 'forall', 'help', 'config', 'topdir', 'selfupdate')
$
</code></pre></div></div><p>資料によると、いくつかの環境変数を設定する必要があります。これは、また後で直します。</p><p>Zephyr Project参考資料: <a href="https://docs.zephyrproject.org/latest/develop/env_vars.html">環境変数</a></p><p>一時的に、Zephyr環境スクリプトを実行します。これで、環境変数はターミナルが閉じるまで使えます。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ source ~/zephyrproject/zephyr/zephyr-env.sh
$ west build -b nucleo_f411re
-- west build: generating a build system
Loading Zephyr default modules (Zephyr base).
-- Application: /Users/user/Desktop/gpio_int_test
-- Found Python3: /usr/local/opt/python@3.9/bin/python3.9 (found suitable exact version "3.9.13") found components: Interpreter
-- Cache files will be written to: /Users/user/Library/Caches/zephyr
-- Zephyr version: 3.0.99 (/Users/user/zephyrproject/zephyr)
-- Found west (found suitable version "0.13.1", minimum required is "0.7.1")
-- Board: nucleo_f411re
...
[156/156] Linking C executable zephyr/zephyr.elf
Memory region         Used Size  Region Size  %age Used
           FLASH:       15108 B       512 KB      2.88%
            SRAM:        4416 B       128 KB      3.37%
        IDT_LIST:          0 GB         2 KB      0.00%
</code></pre></div></div><p>問題なくコンパイルが通りました。</p><h3 id="vs-codeプロジェクトのセットアップ">VS Codeプロジェクトのセットアップ</h3><p>VS CodeでスタンドアロンZephyrアプリをセットアップしましょう。コピーしたプロジェクトフォルダーをVS Codeで開きます。ビルドフォルダーを削除します。</p><p>Zephyr環境変数をプロジェクトに追加しましょう。これにより、環境変数がVS Codeターミナルに追加されます。</p><ol><li>新しいフォルダーを作り、名前を .vscode にします。</li><li>そして、中に新しいファイルを作り、名前を settings.json にします。</li><li>ここに環境変数設定を入れます。<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
 "terminal.integrated.env.osx": {
     "PATH": "$HOME/zephyrproject/zephyr/scripts",
     "ZEPHYR_BASE": "${env:HOME}/zephyrproject/zephyr",
 },
 "terminal.integrated.env.linux": {
     "PATH": "$HOME/zephyrproject/zephyr/scripts:${env:PATH}",
     "ZEPHYR_BASE": "${env:HOME}/zephyrproject/zephyr",
 },
 "terminal.integrated.env.windows": {
     "PATH": "${env:USERPROFILE}\\zephyrproject\\zephyr\\scripts;${env:PATH}",
     "ZEPHYR_BASE": "${env:USERPROFILE}\\zephyrproject\\zephyr",
 },
}
</code></pre></div></div><p>ワークスペース設定の詳細については、<a href="https://github.com/MrGreensWorkshop/ZephyrOS_manifests_and_vscode_settings">こちら</a>を参照してください。</p></li><li>次に、プロジェクトを再度開き、コンパイルしてみます。<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ west build -b nucleo_f411re
-- west build: generating a build system
Loading Zephyr default modules (Zephyr base).
-- Application: /Users/user/Desktop/gpio_int_test
-- Found Python3: /usr/local/opt/python@3.9/bin/python3.9 (found suitable exact version "3.9.13") found components: Interpreter
-- Cache files will be written to: /Users/user/Library/Caches/zephyr
-- Zephyr version: 3.0.99 (/Users/user/zephyrproject/zephyr)
-- Found west (found suitable version "0.13.1", minimum required is "0.7.1")
-- Board: nucleo_f411re
...
[156/156] Linking C executable zephyr/zephyr.elf
Memory region         Used Size  Region Size  %age Used
        FLASH:       15108 B       512 KB      2.88%
         SRAM:        4416 B       128 KB      3.37%
     IDT_LIST:          0 GB         2 KB      0.00%
</code></pre></div></div></li></ol><p>問題なくコンパイルが通りました。</p><p>ボード名を設定しましょう。CMakeListsファイルを開き、<code class="language-plaintext highlighter-rouge">cmake_minimum_required</code>の後に<code class="language-plaintext highlighter-rouge">set(BOARD rpi_pico)</code>を足してください。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
cmake_minimum_required(VERSION 3.20.0)
set(BOARD rpi_pico)
...
</code></pre></div></div><p>ボードオプションなしでコンパイルしてみましょう。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ west build -p
...
/Users/user/Desktop/gpio_int_test/src/main.c:22:2: error: #error "Unsupported board: sw0 devicetree alias is not defined"
   22 | #error "Unsupported board: sw0 devicetree alias is not defined"
      |  ^~~~~
[117/160] Building C object zephyr/drivers/gpio/CMakeFiles/drivers__gpio.dir/gpio_rpi_pico.c.obj
ninja: build stopped: subcommand failed.
FATAL ERROR: command exited with status 1: /usr/local/bin/cmake --build /Users/user/Desktop/gpio_int_test/build
</code></pre></div></div><p>ラズパイピコボードにスイッチがないため、コンパイルエラーが発生しました。</p><h3 id="switch0の追加">Switch0の追加</h3><p>switch0を追加しましょう。このために、アプリオーバーレイファイルを使います。nucleoボードのデバイスオーバーレイファイルでswitch0の定義を確認してみましょう。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat /Users/wizard/zephyrproject/zephyr/boards/arm/nucleo_f411re/nucleo_f411re.dts
...
/ {
	gpio_keys {
		compatible = "gpio-keys";
		user_button: button {
			label = "User";
			gpios = &lt;&amp;gpioc 13 GPIO_ACTIVE_LOW&gt;;
		};
	};

	aliases {
		led0 = &amp;green_led_2;
		sw0 = &amp;user_button;
	};
};
...
</code></pre></div></div><p>新しいファイルを作り、名前を app.overlay にします。必要なものをその中に入れましょう。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/ {
	gpio_keys {
		compatible = "gpio-keys";
		user_button: button {
			label = "User";
			gpios = &lt;&amp;gpio0 28 GPIO_ACTIVE_LOW&gt;;
		};
	};

	aliases {
		sw0 = &amp;user_button;
	};
};
</code></pre></div></div><p>Zephyr Project参考資料: <a href="https://docs.zephyrproject.org/latest/build/dts/howtos.html">Device tree HOW TOs</a></p><p>私の回路で、スイッチはGPIO28に接続されています。回路図は後でお見せします。</p><p>コンパイルしてみましょう。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ west build -p
WARNING: This looks like a fresh build and BOARD is unknown; so it probably won't work. To fix, use --board=&lt;your-board&gt;.
Note: to silence the above message, run 'west config build.board_warn false'
-- west build: generating a build system
...
[160/160] Linking C executable zephyr/zephyr.elf
Memory region         Used Size  Region Size  %age Used
      BOOT_FLASH:         256 B        256 B    100.00%
           FLASH:       11940 B    2096896 B      0.57%
            SRAM:        3760 B       264 KB      1.39%
        IDT_LIST:          0 GB         2 KB      0.00%
Converting to uf2, output size: 24576, start address: 0x10000000
Wrote 24576 bytes to zephyr.uf2
$ gpio_int_test %
</code></pre></div></div><p>やったー！</p><p>バイナリファイルは build/zephyr フォルダーにあります。</p><p>westコマンドの詳細について、以下の資料を参考にしてください。</p><p>Zephyr Project参考資料: <a href="https://docs.zephyrproject.org/latest/develop/west/build-flash-debug.html">ビルド、フラッシュ、およびデバッグ</a></p><h3 id="デバッグする方法">デバッグする方法</h3><p>ラスパイピコ上のZephyrOS + アプリを使用したオンチップデバッグ</p><p>必要なもの</p><ul><li>ハードウェアデバッガインターフェイス（SWD）<ul><li>picoprobe ファームウェアが書き込まれたラスパイピコ</li><li>オンチップデバッグ用のソフトウェア<ul><li>picoprobe用のOpenOCDビルド</li><li>アームツールチェーン<ul><li>arm-none-eabi-gdb</li></ul></li><li>VS Code の Cortex-Debug 拡張機能</li></ul></li></ul></li></ul><p>オンチップデバッグするには、いくつかのハードウェアとソフトウェアが必要です。 一つずつ準備していきましょう。</p><h4 id="ハードウェアデバッガーインターフェイス">ハードウェアデバッガーインターフェイス</h4><p>まずはハードウェアです。ハードウェアデバッガーインターフェイスとしてpicoprobeを使います。</p><p><img class="lozad imgViewer mfp-zoom" data-mfp-src="/assets/img/posts/id_raspi_pico_zephyr_os_part2/Shotcut_00_04_51_700_hw_if.jpg" data-src="/assets/img/posts/id_raspi_pico_zephyr_os_part2/Shotcut_00_04_51_700_hw_if.jpg" alt="PicoProbe" data-align="center" /></p><p>picoprobe用にコンパイルされたバイナリをダウンロードし、ラズパイピコに書き込みましょう。<a href="https://www.raspberrypi.com/documentation/microcontrollers/raspberry-pi-pico.html#debugging-using-another-raspberry-pi-pico">このリンク</a>を開き、</p><p><code class="language-plaintext highlighter-rouge">Debugging using another Raspberry Pi Pico</code> の下にある　<code class="language-plaintext highlighter-rouge">Download the UF2 file</code>　からダウンロードしてください。</p><p>ラズパイピコのbootselボタンを押しながらパソコンに差し、ブートローダーモードにします。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cp ~/Downloads/picoprobe.uf2 /Volumes/RPI-RP2/
</code></pre></div></div><h4 id="openocdのビルド">OpenOCDのビルド</h4><p>現在、OpenOCDはpicoprobeを公式にサポートしていないので、picoprobe用のバージョンをビルドする必要があります。</p><p><em>macOS用</em></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~/
brew install libtool automake libusb wget pkg-config gcc texinfo
git clone https://github.com/raspberrypi/openocd.git --branch picoprobe --depth=1
cd openocd
export PATH="/usr/local/opt/texinfo/bin:$PATH"
./bootstrap
./configure --enable-picoprobe --disable-werror
make -j4
</code></pre></div></div><p><em>Linux用</em></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~/pico
sudo apt install automake autoconf build-essential texinfo libtool libftdi-dev libusb-1.0-0-dev
git clone https://github.com/raspberrypi/openocd.git --branch picoprobe --depth=1 --no-single-branch
cd openocd
./bootstrap
./configure --enable-picoprobe
make -j4
sudo make i
</code></pre></div></div><p>これはOpenOCDのラズパイピコ固有のバージョンなので、「makeinstall」を実行する必要はありません。後でOpenOCDのパスを VS Code プロジェクトに設定します。</p><p>OpenOCDを確認してみましょう。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ~/openocd/src/openocd --version
Open On-Chip Debugger 0.11.0-g4f2ae61 (2022-06-08-15:59)
Licensed under GNU GPL v2
For bug reports, read
	http://openocd.org/doc/doxygen/bugs.html
</code></pre></div></div><h4 id="armツールのインストール">ARMツールのインストール</h4><p><em>macOS用</em></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~/
brew tap eblot/armeabi
brew install arm-none-eabi-gdb
</code></pre></div></div><p>arm-none-eabi-gdbを確認してみましょう。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ arm-none-eabi-gdb --version
GNU gdb (GDB) 10.1
Copyright (C) 2020 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
</code></pre></div></div><h4 id="vs-codeの設定">VS Codeの設定</h4><ol><li>まず、Cortex-Debugをインストールします。</li><li>settings.jsonファイルを開き、OpenOCDのバイナリパスを追加します。<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
 "cortex-debug.openocdPath": "${env:HOME}/openocd/src/openocd",
 ...
</code></pre></div></div></li><li>.vscodeフォルダーに新しいファイルを作り、名前を launch.json にします。そして、設定を追加します。<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "version": "0.2.0",
  "configurations": [{
 "name": "Pico Zephyr Debug",
 "device": "RP2040",
 "gdbPath": "arm-none-eabi-gdb",
 "cwd": "${workspaceRoot}",
 "executable": "build/zephyr/zephyr.elf",
 "request": "launch",
 "type": "cortex-debug",
 "servertype": "openocd",
 "configFiles": [
   "/interface/picoprobe.cfg",
   "/target/rp2040.cfg"
 ],
 "searchDir": ["${env:HOME}/openocd/tcl"],
 "svdFile": "${env:HOME}/zephyrproject/modules/hal/rpi_pico/src/rp2040/hardware_regs/rp2040.svd",
 "runToEntryPoint": "main",
 "postRestartCommands": [
   "break main",
   "continue"
 ]
  }]
}
</code></pre></div></div></li></ol><h4 id="最終回路図">最終回路図</h4><p>これはこれから使う回路の回路図です。左はハードウェアデバッガインターフェイス、右はボタンのあるターゲットボードです。</p><p><img class="lozad imgViewer mfp-zoom" data-mfp-src="/assets/img/posts/id_raspi_pico_zephyr_os_part2/pico_probe_hw_with_targe_sw.jpg" data-src="/assets/img/posts/id_raspi_pico_zephyr_os_part2/pico_probe_hw_with_targe_sw.jpg" alt="Schematic diagram" data-align="center" /></p><h4 id="デバッグ開始">デバッグ開始</h4><p>main.cを開き、行番号の左側をクリックします。それに応じてブレークポイントが追加されます。</p><p><img class="lozad imgViewer mfp-zoom" data-mfp-src="/assets/img/posts/id_raspi_pico_zephyr_os_part2/Shotcut_00_07_19_500_breakpoint.jpg" data-src="/assets/img/posts/id_raspi_pico_zephyr_os_part2/Shotcut_00_07_19_500_breakpoint.jpg" alt="ブレークポイント" data-align="center" /></p><p>デバッグする前にコンパイルすることを忘れないでください。次に、左側の「実行とデバッグ」アイコンをクリックします。「デバッグの開始」をクリックします。</p><p><img class="lozad imgViewer mfp-zoom" data-mfp-src="/assets/img/posts/id_raspi_pico_zephyr_os_part2/debug.jpg" data-src="/assets/img/posts/id_raspi_pico_zephyr_os_part2/debug.jpg" alt="デバッグ" data-align="center" /></p><p>やったー！</p><p>Zephyrコンソールの出力をシリアルターミナルで確認してみましょう。ボタンを押して、コンソールの出力を確認してみましょう。</p><p><img class="lozad imgViewer mfp-zoom" data-mfp-src="/assets/img/posts/id_raspi_pico_zephyr_os_part2/Shotcut_00_08_48_567_debug_ser.jpg" data-src="/assets/img/posts/id_raspi_pico_zephyr_os_part2/Shotcut_00_08_48_567_debug_ser.jpg" alt="デバッグとコンソールの出力" data-align="center" /></p><p>素晴らしい！</p><h3 id="スポンサーシップ">スポンサーシップ</h3><p>何もないところからプロジェクトを立ち上げるのは、とても時間がかかるものです。私がこの様なプロジェクトに取り組み続け、皆さんに新しいコンテンツを提供できるよう、支援をご検討いただければ幸いです。</p><ul><li><a href="https://patreon.com/MrGreenWorkshop" title="Patreonで支援">Patreon</a>で支援する（月々）</li><li><a href="https://ko-fi.com/MrGreenWorkshop" title="Ko-fiで支援">Ko-fi</a>で支援する (一回)</li><li><a href="https://github.com/sponsors/MrGreensWorkshop" title="GitHubでスポンサーになる">GitHubでスポンサー</a>になる (一回／月々)</li></ul><h3 id="最後に">最後に</h3><p>ラズパイピコ Zephyr RTOS VS Codeプロジェクトに、<a href="https://github.com/MrGreensWorkshop/ZephyrOS_ButtonRasPiPicoVScodeDebug">こちらのリンク</a>からアクセスできます。</p><p>次のエピソードでは、ZephyrOSを使って実際のアプリケーションについて説明します。</p><p>つづく…</p><hr><div class="share-holder"> <span class="share-label">シェア: </span><ul class="share-buttons"><li> <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fwww.mrgreensworkshop.com%2Fja%2F2022-06-16-raspberry-pi-pico-zephyr-os-part-2&amp;text=%E3%83%A9%E3%82%BA%E3%83%91%E3%82%A4%E3%83%94%E3%82%B3%E3%81%A7ZephyrOS%E5%8B%95%E3%81%8B%E3%81%97%E3%80%81VS%20Code%E3%81%A7%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%97%E3%81%A6%E3%81%BF%E3%82%88%E3%81%86%20-%20Mr.%20Green&#39;s%20Workshop" aria-label="Twitter" role="button" target="_blank" rel="noopener noreferrer" data-toggle="tooltip" data-placement="top" title="Twitter" class="hover-effect-big"> <i class="fa fa-twitter-square fa-fw" aria-hidden="true"></i> </a></li><li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.mrgreensworkshop.com%2Fja%2F2022-06-16-raspberry-pi-pico-zephyr-os-part-2" aria-label="Facebook" role="button" target="_blank" rel="noopener noreferrer" data-toggle="tooltip" data-placement="top" title="Facebook" class="hover-effect-big"> <i class="fa fa-facebook-square fa-fw" aria-hidden="true"></i> </a></li><li> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.mrgreensworkshop.com%2Fja%2F2022-06-16-raspberry-pi-pico-zephyr-os-part-2&amp;text=%E3%83%A9%E3%82%BA%E3%83%91%E3%82%A4%E3%83%94%E3%82%B3%E3%81%A7ZephyrOS%E5%8B%95%E3%81%8B%E3%81%97%E3%80%81VS%20Code%E3%81%A7%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%97%E3%81%A6%E3%81%BF%E3%82%88%E3%81%86%20-%20Mr.%20Green&#39;s%20Workshop" aria-label="Telegram" role="button" target="_blank" rel="noopener noreferrer" data-toggle="tooltip" data-placement="top" title="Telegram" class="hover-effect-big"> <i class="fa fa-telegram fa-fw" aria-hidden="true"></i> </a></li><li> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.mrgreensworkshop.com%2Fja%2F2022-06-16-raspberry-pi-pico-zephyr-os-part-2" aria-label="LinkedIn" role="button" target="_blank" rel="noopener noreferrer" data-toggle="tooltip" data-placement="top" title="LinkedIn" class="hover-effect-big"> <i class="fa fa-linkedin-square fa-fw" aria-hidden="true"></i> </a></li><li> <a href="mailto:?subject=%E3%83%A9%E3%82%BA%E3%83%91%E3%82%A4%E3%83%94%E3%82%B3%E3%81%A7ZephyrOS%E5%8B%95%E3%81%8B%E3%81%97%E3%80%81VS%20Code%E3%81%A7%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%97%E3%81%A6%E3%81%BF%E3%82%88%E3%81%86%20-%20Mr.%20Green&#39;s%20Workshop&amp;body=%E3%83%A9%E3%82%BA%E3%83%91%E3%82%A4%E3%83%94%E3%82%B3%E3%81%A7ZephyrOS%E5%8B%95%E3%81%8B%E3%81%97%E3%80%81VS%20Code%E3%81%A7%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%97%E3%81%A6%E3%81%BF%E3%82%88%E3%81%86%20-%20Mr.%20Green&#39;s%20Workshop%20https%3A%2F%2Fwww.mrgreensworkshop.com%2Fja%2F2022-06-16-raspberry-pi-pico-zephyr-os-part-2" aria-label="メール" role="button" target="_blank" rel="noopener noreferrer" data-toggle="tooltip" data-placement="top" title="メール" class="hover-effect-big"> <i class="fa fa-envelope fa-fw" aria-hidden="true"></i> </a></li><li> <a href="javascript:void(0);" aria-label="リンクをコピー" role="button" onclick="copyToClipboard('https://www.mrgreensworkshop.com/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2', 'リンクがコピーされました!')" id="copytoclipboard" data-toggle="tooltip" data-placement="top" title="リンクをコピー" class="hover-effect-big"> <i class="fa fa-link fa-fw" aria-hidden="true"></i> </a></li></ul></div></div></div><div class="pagination_wrapper"><nav aria-label="Page navigation"><ul class="pagination" style="opacity:0"><li><a href="javascript:void(0);" role="button">1</a></li></ul></nav></div><div id="comment_thread"><div id="giscus_thread"></div></div><noscript> コメントを表示するには、JavaScriptを有効にしてください。 </noscript></div><div class="footer-wrapper"><div class="footer-container"><footer translate="no"><div class="footer-text footer-text-centered long-copyright"><p>&copy; 2022 Mr. Green's Workshop. 著作権で保護されています。</p></div><p class="footer-powered"><span>Pwrd by </span><a href="https://github.com/MrGreensWorkshop/MrGreen-JekyllTheme" target="_blank" rel="noopener noreferrer">Mr. Green</a></p></footer></div></div><div class="scroll-to-top-container"> <a id="scroll-to-top" href="#main-wrapper" role="button" aria-label="トップへ戻る" class="hover-effect"><i class="fa fa-angle-up"></i></a></div></div><div class="searchbox-container"> <form id="searchbox-form" autocomplete="off"> <input type="search" id="search-box" placeholder="検索" onkeyup="if(this.value!==''){document.getElementById('search-results').style.display = 'block';}" onfocusout="this.value='';" onblur="setTimeout(function(){ document.getElementById('search-results').style.display = 'none'; }, 100);"><ul id="search-results" ></ul></form></div><script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v0.4.1/dist/bootstrap-toc.min.js"></script> <script src="/assets/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script> <script> $('.imgViewer[data-no-image-viewer]').css("cursor", "unset"); $(function () { $('.imgViewer:not([data-no-image-viewer])').magnificPopup({ type: 'image' ,image: { titleSrc: 'alt' /* Error message */ ,tError: "画像が読み込めませんでした。<br><br>%url%" /* Set to null to disable zoom out cursor. */ /*,cursor: null */ } ,closeOnContentClick: true ,showCloseBtn: false ,zoom: { /* By default it's false, so don't forget to enable it */ enabled: true /* duration of the effect, in milliseconds */ ,duration: 300 /* CSS transition easing function */ ,easing: 'ease-in-out' } }); }); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js"></script> <script> /* lazy loads elements with default selector as '.lozad' */ const observer = lozad(); observer.observe(); </script> <script> PagerPageNumbers.setProperties({ paginatorListContainerName: ".pagination_wrapper .pagination" ,pageList: ["/ja/2022-06-16-raspberry-pi-pico-zephyr-os-part-2", "/ja/2022-05-29-diy-3d-printer-part-2", "/ja/2022-05-29-diy-3d-printer-part-1", "/ja/2022-03-03-mr-green-jekyll-theme"] ,firstButtonName: "最初" ,lastButtonName: "最後" ,prevButtonName: "«" ,nextButtonName: "»" }); </script> <script src="/assets/js/simple-jekyll-search-1.9.2.min.js"></script><script> function loadSearch(jsonData, searchParam) { if (!jsonData) jsonData = '/ja/query/search.json'; var searchInput = document.getElementById('search-box'); const simpleJekyllSearch = SimpleJekyllSearch({ searchInput: searchInput ,resultsContainer: document.getElementById('search-results') ,json: jsonData ,searchResultTemplate: '<li> <a href="{url}"><div><div class="title">{title}</div><div class="date">{date}</div><div style="clear: both;"></div></div></a></li>' ,noResultsText: '<li>何も見つかりませんでした。</li>' ,limit: 10 ,fuzzy: false ,formSubmit: document.getElementById('searchbox-form') }); if (searchParam) { searchInput.value = searchParam; searchInput.focus(); searchInput.disabled=false; setTimeout(function(){ simpleJekyllSearch.search(searchParam); }, 400); } } </script> <script> let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "MrGreensWorkshop/comments", "data-repo-id": "R_kgDOI4CvPA", "data-category": "mrgreensworkshop", "data-category-id": "DIC_kwDOI4CvPM4CUDTQ", "data-mapping": "pathname", "data-strict": "1", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-input-position": "bottom", "data-theme": giscusGetColorTheme(), "data-lang": "ja", "data-loading": "lazy", "crossorigin": "anonymous", "async": "" }; function engineLoader() { let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("giscus_thread").appendChild(giscusScript); } /* set giscus theme, when data-color-scheme changes. (dark, light) */ function giscusGetColorTheme() { let theme = "light_protanopia"; if (document.body.dataset.colorScheme == "light") { theme = "light_protanopia"; } else if (document.body.dataset.colorScheme == "dark") { theme = "dark_protanopia"; } return theme; } function giscusSetColorScheme() { function giscusSetConfig(config) { const giscusIframe = document.querySelector('iframe.giscus-frame'); if (!giscusIframe) return; giscusIframe.contentWindow.postMessage({ giscus: config }, 'https://giscus.app'); } giscusSetConfig({ setConfig: { theme: giscusGetColorTheme() } }); } const color_scheme_observer = new MutationObserver(giscusSetColorScheme); color_scheme_observer.observe(document.body, {attributeFilter: ["data-color-scheme"]}); /* load when slide to the end of page */ let isMobile = false; function page_bottom_Check(event) { let wind = event.target.scrollingElement; let showBeforeEndOffset = 50; if (isMobile) { /* mobile fix */ showBeforeEndOffset += 56; } if (wind.offsetHeight + wind.scrollTop >= wind.scrollHeight - commentPageOffset - showBeforeEndOffset) { engineLoader(); document.removeEventListener('scroll', page_bottom_Check); slideToComments(); } } const commentPageOffset = document.querySelector('#comment_thread').clientHeight; document.addEventListener('scroll', page_bottom_Check); window.addEventListener("load", function() { isMobile = navigator.userAgent.toLowerCase().match(/mobile/i); let checkScroll = true; if (isMobile) { /* mobile fix */ clientHeight = document.documentElement.clientHeight + 56; } else { clientHeight = document.documentElement.clientHeight; } const scroll_enabled = document.documentElement.scrollHeight > clientHeight; if (checkScroll == true && scroll_enabled == false) { /* if no scroll bar, load at startup */ document.removeEventListener('scroll', page_bottom_Check); engineLoader(); slideToComments(); } }); /* scroll to page bottom to see comments. */ function slideToComments() { document.getElementById('comment_thread').style.minHeight = '324px'; window.scrollTo(0, document.body.scrollHeight); } </script> <script> CookieConsent.consentSettingHtml = "<div class=\"consent-settings\"><h5>クッキー設定</h5><br><p class=\"info-text\">当Webサイトは、機能を最適化するためにクッキーを使用しています。 承認後に有効になります。クッキーポリシーについては、以下の各項目をクリックしてください。</p><table><tr><td onclick=\"$('.info[data-consent-info=necessary]').slideToggle();$(this).children('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o')\"> <i class=\"fa-fw fa fa-plus-square-o\" aria-hidden=\"true\"></i><p>不可欠なクッキー</p></td><td> <span class=\"active_text\">常時有効</span></td></tr></table><div class=\"info\" data-consent-info=\"necessary\"><p>このCookieは、Webサイトの機能に不可欠であり、無効にすることはできません。 通常、配色などのサイト機能を変更したときに設定されます。 このCookieには、個人を特定できる情報は保存されません。 認証機能、不正行為防止、その他のユーザー保護など、 セキュリティに関連する保存を有効にします。</p></div><table><tr><td onclick=\"$('.info[data-consent-info=analytics]').slideToggle();$(this).children('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o')\"> <i class=\"fa-fw fa fa-plus-square-o\" aria-hidden=\"true\"></i><p>パフォーマンスクッキー</p></td><td> <span class=\"active_text\">常時有効</span></td></tr></table><div class=\"info\" data-consent-info=\"analytics\"><p>訪問時の滞在時間などの分析に関連する保存（Cookie など）を有効にします。</p></div><table><tr><td onclick=\"$('.info[data-consent-info=preferences]').slideToggle();$(this).children('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o')\"> <i class=\"fa-fw fa fa-plus-square-o\" aria-hidden=\"true\"></i><p>機能性クッキー</p></td><td> <label class=\"slide-switch\"> <input type=\"checkbox\" class=\"checkbox_switch\" data-consent=\"preferences\"> <span class=\"slider\"></span> </label></td></tr></table><div class=\"info\" data-consent-info=\"preferences\"><p>Webサイトまたはアプリの機能（言語設定など）をサポートする保存を有効にします。 おすすめの動画など、パーソナライズに関連する保存を有効にします。</p></div><table><tr><td onclick=\"$('.info[data-consent-info=advertising]').slideToggle();$(this).children('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o')\"> <i class=\"fa-fw fa fa-plus-square-o\" aria-hidden=\"true\"></i><p>ターゲティング広告クッキー</p></td><td> <label class=\"slide-switch\"> <input type=\"checkbox\" class=\"checkbox_switch\" data-consent=\"advertising\"> <span class=\"slider\"></span> </label></td></tr></table><div class=\"info\" data-consent-info=\"advertising\"><p>広告に関連する保存（Cookie など）を有効にします。</p></div><br><div class=\"button-holder\"> <a href=\"javascript:void(0);\" class=\"btn-base btn-left\" onclick=\"CookieConsent.consentSettingDone('deny');\" role=\"button\" rel=\"nofollow\">拒否</a> <a href=\"javascript:void(0);\" class=\"btn-base btn-priority\" onclick=\"CookieConsent.consentSettingDone('accept');\" role=\"button\" rel=\"nofollow\">全て許可</a> <a href=\"javascript:void(0);\" class=\"btn-base \" onclick=\"CookieConsent.consentSettingDone('save');\" role=\"button\" rel=\"nofollow\">選択を許可</a></div></div>"; CookieConsent.consentSettingSlideType = 'slideBoxTopToDown'; CookieConsent.consentBarHtml = "<div class=\"consent-bar\"> <a class=\"close-button\" href=\"javascript:void(0);\" onclick=\"CookieConsent.hideConsentBar();\" aria-label=\"閉じる\" role=\"button\" rel=\"nofollow\"><i class=\"fa-fw fa fa-times\"></i></a><p>当Webサイトは、機能を最適化するためにクッキーを使用しています。 承認後に有効になります。</p><a href=\"javascript:void(0);\" class=\"btn-base \" onclick=\"CookieConsent.consentBarDone('deny');\" role=\"button\" rel=\"nofollow\">拒否</a> <a href=\"javascript:void(0);\" class=\"btn-base \" onclick=\"CookieConsent.consentBarDone('settings');\" role=\"button\" rel=\"nofollow\">設定</a> <a href=\"javascript:void(0);\" class=\"btn-base btn-priority\" onclick=\"CookieConsent.consentBarDone('accept');\" role=\"button\" rel=\"nofollow\">全て許可</a></div>"; CookieConsent.consent_items = JSON.parse('{"necessary":{"group":["security_storage"],"value":"granted","wait_for_update":500,"cookie_domain":"www.mrgreensworkshop.com","no_check_box":true},"analytics":{"group":["analytics_storage"],"value":"granted","no_check_box":true},"preferences":{"group":["functionality_storage","personalization_storage"],"value":"denied"},"advertising":{"group":["ad_storage"],"value":"denied"}}'); CookieConsent.hideConsentBarWithSaveButton = true; const consent_settings = CookieConsent.getConsentSettings(); const default_configs = JSON.parse('{"anonymize_ip":true,"ads_data_redaction":true,"cookie_flags":"SameSite=None;Secure"}'); </script> <script> window.dataLayer = window.dataLayer || []; function gtag() {dataLayer.push(arguments);} CookieConsent.gtag = gtag; if (Object.keys(consent_settings).length > 0) gtag("consent", "default", consent_settings); if (Object.keys(default_configs).length > 0) gtag("set", default_configs); </script><script defer src="https://www.googletagmanager.com/gtag/js?id=G-SC87NNMPP8"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() {dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SC87NNMPP8'); </script> <script> LangOfferMsgBox.currentPageLng = "ja"; LangOfferMsgBox.supportedLngList = [["en","En","/","View this page in English.","To home","Language"],["ja","Jp","/ja","このページを日本語で表示する。","日本語ホームへ","言語"]]; LangOfferMsgBox.existLng = [["en","En","/posts/2022-06-10-raspberry-pi-pico-zephyr-os-part-2"]]; LangOfferMsgBox.disableExtTranslationOffer = true; LangOfferMsgBox.slideType = 'slideBoxTopToDown'; </script> <script> SlidingMsgBox.html = "<div class=\"slideBox\"> <a class=\"close-button\" href=\"javascript:void(0);\" aria-label=\"閉じる\" role=\"button\" rel=\"nofollow\"><i class=\"fa-fw fa fa-times\"></i></a></div>"; </script></body></html>
